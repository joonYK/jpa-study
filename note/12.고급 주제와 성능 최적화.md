# 예외 처리

* JPA를 사용할 떄 발생하는 다양한 예외와 예외에 따른 주의점들.

## JPA 표준 예외

* javax.persistence.PersistenceException의 자식 클래스.
  * 모든 JPA 예외는 javax.persistence 패키지에 있음. 
  * RuntimeException의 자식. (모두 언체크 예외)
* 트랜잭션 롤백을 표시하는 예외와 표시하지 않는 예외 2가지로 나뉨.
  * 롤백을 표시하는 예외는 심각한 예외로 복구하면 안 됨.
    * 트랜잭션을 강제로 커밋해도 RollbackException 예외 발생.
  * 롤백을 표시하지 않는 예외는 심각한 예외가 아니므로 개발자가 커밋 또는 롤백할지 판단.

### 트랜잭션 롤백을 표시하는 예외

|예외|설명|
|---|---|
|EntityExistsException|EntityManager.persist()호출 시 이미 같은 엔티티가 있으면 발생.|
|EntityNotFoundException|EntityManager.getReference()를 호출했지만 실제 사용 시 엔티티가 존재하지 않으면 발생.<br/>refresh(), lock()에서도 발생.|
|OptimisticLockException|낙관적 락 충돌 시 발생.|
|PessimisticLockException|비관적 락 충돌 시 발생.|
|RollbackException|EntityTransaction.commit() 실패 시 발생.<br/>롤백이 표시되어 있는 트랜잭션 커밋 시에도 발생.|
|TransactionRequiredException|트랜잭션이 필요할 때 트랜잭션이 없으면 발생.<br/>트랜잭션이 없이 엔티티를 변경할 때 주로 발생.|

### 트랜잭션 롤백을 표시하지 않는 예외

|예외|설명|
|---|---|
|NoResultException|Query.getSingleResult() 호출 시 결과가 하나도 없을 때 발생.|
|NonUniqueResultException|Query.getSingleResult() 호출 시 결과가 둘 이상일 때 발생.|
|LockTimeoutException|비관적 락에서 시간 초과 시 발생.|
|QueryTimeoutException|쿼리 실행 시간 초과 시 발생.|

## 스프링 프레임워크의 JPA 예외 변환

* 서비스 계층에서 JPA의 예외를 직접 사용하면 JPA에 의존하게 됨.
* 스프링 프레임워크는 이런 문제 해결을 위해 데이터 접근 계층에 대한 예외를 추상화 함.

### JPA 예외를 스프링 예외로 변경

|JPA 예외|스프링 변환 예외|
|---|---|
|PersistenceException|org.springframework.orm.jpa.JpaSystemException|
|NoResultException|org.springframework.dao.EmptyResultDataAccessException|
|NonUniqueResultException|org.springframework.dao.IncorrectResultSizeDataAccessException|
|LockTimeoutException|org.springframework.dao.CannotAcquireLockException|
|QueryTimeoutException|org.springframework.dao.QueryTimeoutException|
|EntityExistsException|org.springframework.dao.DataIntegrityViolationException|
|EntityNotFoundException|org.springframework.orm.jpa.JpaObjectRetrievalFailureException|
|OptimisticLockException|org.springframework.org.jpa.JpaOptimisticLockingFailureException|
|PessimisticLockException|org.springframework.dao.PessimisticLockingFailureException|
|TransactionRequiredException|org.springframework.dao.InvalidDataAccessApiUsageException|
|RollbackException|org.springframework.transaction.TransactionSystemException|

## 스프링 프레임워크에 JPA 예외 변환기 적용

* JPA 예외를 스프링 프레임워크의 추상화 예외로 변경하려면 특정 객체를 스프링 빈으로 등록.
  * PersistenceExceptionTranslationPostProcessor
* @Repository를 사용한 곳에 예외 변환 AOP를 적용해서 변환.
* 예외를 변환하고 싶지 않으면 메서드에 thorws로 JPA 예외나 JPA 예외의 부모 클래스를 직접 명시.

## 트랜백션 롤백 시 주의사항

* 트랜잭션 롤백은 DB만 롤백하고 수정한 자바 객체까지 원상태로 복구하지 않음.
  * 즉, 엔티티가 수정된 상태로 영속성 컨텍스트에 남아 있게 됨.
* 새로운 영속성 컨텍스트를 사용하거나 EntityManager.clear()로 초기화한 다음 사용해야 함.

### 스프링 프레임워크의 예방방법

* 영속성 컨텍스트의 범위에 따라 다른 방법을 사용.

#### 1. 기본 전략 (트랜잭션당 영속성 컨텍스트)

* 문제가 발생하면 트랜잭션 AOP 종료 시점에 트랜잭션을 롤백하면서 영속성 컨텍스트도 함께 종료.

#### 2. OSIV (영속성 컨텍스트의 범위를 트랜잭션 범위보다 넓게 사용)

* 영속성 컨텍스트에 문제가 있어도 다른 트랜잭션에서 해당 영속성 컨텍스트를 그대로 사용하는 문제가 있음.
* 롤백시 영속성 컨텍스트를 초기화.