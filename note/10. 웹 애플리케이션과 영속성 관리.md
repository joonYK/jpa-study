# 트랜잭션 범위의 영속성 컨텍스트

* 순수하게 J2SE 환경에서 JPA 사용시 개발자가 직접 엔티티 매니저 생성 및 트랜잭션 관리.
* 스프링이나 J2EE 환경은 컨테이너가 제공하는 전략이 있음.

## 스프링 컨테이너의 기본 전략

* 트랜잭션 범위의 영속성 컨텍스트 전략을 기본 사용.
* 트랜잭션의 범위와 영속성 컨텍스트의 생존 범위가 같음.
* 같은 트랜잭션 안에서는 같은 영속성 컨텍스트에 접근.
* 보통 비즈니스 로직을 시작하는 서비스 계층에 @Transactional 선언을 통해 트랜잭션 시작.
    * 메서드 호출 직전에 스프링의 트랜잭션 AOP가 먼저 동작.
    * 메서드 종료시 트랜잭션을 커밋하면서 종료됨.
    * 트랜잭션 커밋 시, JPA는 먼저 영속성 컨텍스트를 플러시해서 DB에 반영.
    * 예외발생시 트랜잭션 롤백하고 플러시 호출은 하지 않음.
* 트랜잭션이 다르면 다른 영속성 컨텍스트 사용.
    * 여러 스레드의 동시 요청으로 같은 엔티티 매니저를 사용해도 트랜잭션에 따라 영속성 컨텍스트 다름.
    * 스프링은 스레드마다 각각 다른 트랜잭션 할당.
    * 멀티스레드 상황에 안전함.
